stages:
  - security

variables:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-Dwarnings"

cache:
  key: "${CI_PROJECT_NAME}"
  paths:
    - target/
    - .cargo/registry/
    - .cargo/git/

# ---------- Security: cargo-audit (non-blocking) ----------
cargo_audit:
  stage: security
  image: rust:1.76
  before_script:
    - cargo install cargo-audit --locked || true
  script:
    - |
      set +e
      cargo audit --json > cargo-audit-report.json
      EXIT_CODE=$?
      set -e
      if [ "$EXIT_CODE" -ne 0 ]; then
        echo "cargo audit reported issues (exit code: $EXIT_CODE), but the pipeline will NOT fail."
      fi
  artifacts:
    when: always
    paths:
      - cargo-audit-report.json
  allow_failure: true
  only:
    - branches
    - merge_requests

# ---------- Security: Trivy filesystem scan (non-blocking) ----------
trivy_fs_scan:
  stage: security
  image:
    name: aquasec/trivy:latest
    entrypoint: [""]
  script:
    - |
      set +e
      trivy fs \
        --exit-code 1 \
        --format json \
        --output trivy-report.json \
        .
      EXIT_CODE=$?
      set -e
      if [ "$EXIT_CODE" -ne 0 ]; then
        echo "Trivy filesystem scan reported issues (exit code: $EXIT_CODE), but the pipeline will NOT fail."
      fi
  artifacts:
    when: always
    paths:
      - trivy-report.json
  allow_failure: true
  only:
    - branches
    - merge_requests

# ---------- Package security reports into a single ZIP ----------
package_security_reports:
  stage: security
  image: alpine:latest
  needs:
    - job: cargo_audit
      artifacts: true
    - job: trivy_fs_scan
      artifacts: true
  script:
    - apk add --no-cache zip
    - zip security-reports.zip cargo-audit-report.json trivy-report.json
  artifacts:
    when: always
    paths:
      - security-reports.zip
  only:
    - branches
    - merge_requests
